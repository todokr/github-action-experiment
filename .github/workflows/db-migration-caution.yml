name: DB Migration Caution

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize]

jobs:
  commenter:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      # migration SQLを対象にキーワードでgrep
      # output: sqls
      # - ヒットした場合はSQLファイルのカンマ区切り文字列
      # - 1件もヒットしない場合は 'SUSPICIOUS_SQL_NOT_DETECTED' の文字列
      - name: Grep Suspicious SQL
        id: grep-suspicious
        run: |
          suspicious_keywords=("drop table" "drop column")
          pattern=$(IFS="|"; echo "${suspicious_keywords[*]}")
          migration_dir="./migration"
          suspicious_sqls=$(find ${migration_dir}/*.sql | xargs grep -li -E "${pattern}" || echo 'SUSPICIOUS_SQL_NOT_DETECTED')
          suspicious_sqls="${suspicious_sqls//$'\n'/,}"
          echo "::set-output name=sqls::$suspicious_sqls"

      # 自動生成コードの削除or変更を検知
      - name: Detect Change in Auto Generated File
        id: detect-change-auto-generated-file
        uses: dorny/paths-filter@v2
        with:
          list-files: 'csv'
          filters: |
            model:
              - deleted|modified: '**/model/*.scala'

      # コメントがすでに存在しないか確認し
      # - name: Check existing caution comment
      #   uses: peter-evans/find-comment@v1
      #   id: check-migration-comment
      #   with:
      #     issue-number: ${{ github.event.pull_request.number }}
      #     comment-author: 'github-actions[bot]'
      #     body-includes: Contains db migration!

      # markdown用にフォーマット
      - name: Format Comment Body
        id: format-body
        if: steps.grep-suspicious.outputs.sqls != 'SUSPICIOUS_SQL_NOT_DETECTED' &&
            steps.detect-change-auto-generated-file.outputs.model == 'true'
        run: |
          suspicious_sqls=${{ steps.grep-suspicious.outputs.sqls }}
          suspicious_sql_list="- ${suspicious_sqls//','/'%0A- '}"
          echo "::set-output name=suspicious-sql-list::$suspicious_sql_list"
          model_files=${{ steps.detect-change-auto-generated-file.outputs.model_files }}
          model_file_list="- ${model_files//','/'%0A- '}"
          echo "::set-output name=changed-model-list::$model_file_list"

      # コメントを追記
      - name: Write DB migration caution comment
        uses: peter-evans/create-or-update-comment@v1
        if: steps.grep-suspicious.outputs.sqls != 'SUSPICIOUS_SQL_NOT_DETECTED' &&
            steps.detect-change-auto-generated-file.outputs.model == 'true'
            # steps.check-migration-comment.outputs.comment-id == ''
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            Contains db migration!
            ### SQLs
            ${{ steps.format-body.outputs.suspicious-sql-list }}

            ### Auto Generated Files
            ${{ steps.format-body.outputs.changed-model-list }}